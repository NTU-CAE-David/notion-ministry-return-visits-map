<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Notion 續訪地址互動地圖 Pro 版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body { margin: 0; }
    #map { height: 100vh; }
    .popup-content { font-size: 14px; line-height: 1.4; }
    .controls {
      position: absolute;
      top: 60px; /* 往下移避免與 Leaflet 控制重疊 */
      left: 10px;
      background: white;
      padding: 8px;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      border-radius: 6px;
    }
    input, select, button {
      margin-bottom: 5px;
      width: 160px;
      padding: 3px;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .legend div { margin-bottom: 4px; }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 6px;
      vertical-align: middle;
    }
    .nav-button {
      display: inline-block;
      background: #1E90FF;
      color: white;
      padding: 6px 12px;
      margin-top: 5px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: bold;
    }
    .status {
      font-size: 12px;
      color: #555;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <input type="text" id="nameFilter" placeholder="搜尋姓名...">
    <input type="text" id="cardFilter" placeholder="搜尋區域卡...">
    <select id="sortOption">
      <option value="">排序方式</option>
      <option value="星等">星等</option>
      <option value="拜訪日期">拜訪日期</option>
    </select>
    <select id="assignGroup">
      <option value="">指派人員</option>
    </select>
    <button id="updateBtn">🔄 手動更新 Notion</button>
    <div class="status" id="updateStatus">尚未觸發更新</div>
  </div>
  <div id="map"></div>
  <div class="legend" id="legend"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    const map = L.map('map').setView([25.038, 121.563], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data © OpenStreetMap contributors',
      maxZoom: 19,
    }).addTo(map);

    const dataUrl = "https://script.google.com/macros/s/AKfycbx3s34E7AvuipBNUJeOT17ABAf0fizNbqP_NbpnCCF1n5w2jO-LeCcf5HEae7p2ycRc/exec";
    const token = "c66c5f17-8f98-4a93-a041-4e9e2309e5b2";
    const triggerUrl = `${dataUrl}?token=${token}`;
    const markers = L.markerClusterGroup();
    let markerList = [];
    const assignColorMap = {};

    document.getElementById("updateBtn").addEventListener("click", () => {
      const status = document.getElementById("updateStatus");
      status.textContent = "正在觸發更新...";

      fetch(triggerUrl)
        .then(res => res.json())
        .then(msg => {
          console.log("🟢 App Script 更新結果：", msg);
          if (msg.count !== undefined) {
            status.textContent = `✅ 已觸發更新 (${msg.count}/2)`;
          } else if (msg.error) {
            status.textContent = `⚠️ ${msg.error}`;
          } else {
            status.textContent = "⚠️ 回傳格式錯誤，請檢查 doGet() 是否有 JSON 輸出";
          }
          loadData();
        })
        .catch(err => {
          console.error("❌ App Script 更新失敗：", err);
          status.textContent = "❌ 無法更新資料，請查看 console log。";
          loadData();
        });
    });
  </script>
</body>
</html>
