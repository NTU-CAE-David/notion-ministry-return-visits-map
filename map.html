<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Notion çºŒè¨ªåœ°å€äº’å‹•åœ°åœ– Pro ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body { margin: 0; }
    #map { height: 100vh; }
    .popup-content { font-size: 14px; line-height: 1.4; }
    .controls {
      position: absolute;
      top: 60px; /* å¾€ä¸‹ç§»é¿å…èˆ‡ Leaflet æ§åˆ¶é‡ç–Š */
      left: 10px;
      background: white;
      padding: 8px;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      border-radius: 6px;
    }
    input, select, button {
      margin-bottom: 5px;
      width: 160px;
      padding: 3px;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .legend div { margin-bottom: 4px; }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 6px;
      vertical-align: middle;
    }
    .nav-button {
      display: inline-block;
      background: #1E90FF;
      color: white;
      padding: 6px 12px;
      margin-top: 5px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: bold;
    }
    .status {
      font-size: 12px;
      color: #555;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <input type="text" id="nameFilter" placeholder="æœå°‹å§“å...">
    <input type="text" id="cardFilter" placeholder="æœå°‹å€åŸŸå¡...">
    <select id="sortOption">
      <option value="">æ’åºæ–¹å¼</option>
      <option value="æ˜Ÿç­‰">æ˜Ÿç­‰</option>
      <option value="æ‹œè¨ªæ—¥æœŸ">æ‹œè¨ªæ—¥æœŸ</option>
    </select>
    <select id="assignGroup">
      <option value="">æŒ‡æ´¾äººå“¡</option>
    </select>
    <button id="updateBtn">ğŸ”„ æ‰‹å‹•æ›´æ–° Notion</button>
    <div class="status" id="updateStatus">å°šæœªè§¸ç™¼æ›´æ–°</div>
  </div>
  <div id="map"></div>
  <div class="legend" id="legend"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    const map = L.map('map').setView([25.038, 121.563], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© OpenStreetMap contributors',
      maxZoom: 19,
    }).addTo(map);

    const dataUrl = "https://script.google.com/macros/s/AKfycbx3s34E7AvuipBNUJeOT17ABAf0fizNbqP_NbpnCCF1n5w2jO-LeCcf5HEae7p2ycRc/exec";
    const token = "c66c5f17-8f98-4a93-a041-4e9e2309e5b2";
    const triggerUrl = `${dataUrl}?token=${token}`;
    const markers = L.markerClusterGroup();
    let markerList = [];
    const assignColorMap = {};

    document.getElementById("updateBtn").addEventListener("click", () => {
      const status = document.getElementById("updateStatus");
      status.textContent = "æ­£åœ¨è§¸ç™¼æ›´æ–°...";

      fetch(triggerUrl)
        .then(res => res.json())
        .then(msg => {
          console.log("ğŸŸ¢ App Script æ›´æ–°çµæœï¼š", msg);
          if (msg.count !== undefined) {
            status.textContent = `âœ… å·²è§¸ç™¼æ›´æ–° (${msg.count}/2)`;
          } else if (msg.error) {
            status.textContent = `âš ï¸ ${msg.error}`;
          } else {
            status.textContent = "âš ï¸ å›å‚³æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ doGet() æ˜¯å¦æœ‰ JSON è¼¸å‡º";
          }
          loadData();
        })
        .catch(err => {
          console.error("âŒ App Script æ›´æ–°å¤±æ•—ï¼š", err);
          status.textContent = "âŒ ç„¡æ³•æ›´æ–°è³‡æ–™ï¼Œè«‹æŸ¥çœ‹ console logã€‚";
          loadData();
        });
    });
  </script>
</body>
</html>
